{% extends "base.html" %}

{% block title %}Compress PDF - PyPDF Toolkit Web{% endblock %}

{% block content %}
<div class="main-content">
    <h2 class="page-title"><i class="fas fa-compress-alt"></i> Compress PDF</h2>
    <p class="page-description">
        Reduce the file size of your PDF documents while maintaining quality. Choose from different compression levels based on your needs.
    </p>

    <form id="compressForm" enctype="multipart/form-data">
        <div class="form-group">
            <label class="form-label">Select PDF File</label>
            <div class="file-upload" id="fileUpload">
                <div class="file-upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="file-upload-text">Click to upload or drag and drop a PDF file</div>
                <div class="file-upload-hint">Single PDF file only</div>
                <input type="file" id="fileInput" name="file" class="file-input" accept=".pdf">
            </div>
        </div>

        <div id="fileInfo" class="file-list hidden"></div>

        <div class="form-group">
            <label class="form-label">Compression Level</label>
            <select id="compressionLevel" name="compression_level" class="form-select">
                <option value="low">Low - Minimal compression, best quality</option>
                <option value="medium" selected>Medium - Balanced compression and quality</option>
                <option value="high">High - Maximum compression, reduced quality</option>
            </select>
            <small style="color: #666; font-size: 0.9rem; display: block; margin-top: 5px;">
                Higher compression levels reduce file size more but may affect document quality.
            </small>
        </div>

        <div id="estimateSection" class="hidden" style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e1e5e9;">
            <h4 style="margin-bottom: 15px; color: #333;"><i class="fas fa-chart-bar"></i> Compression Estimate</h4>
            <div id="estimateContent"></div>
        </div>

        <button type="submit" class="btn btn-primary btn-block" id="compressBtn" disabled>
            <i class="fas fa-compress-alt"></i> Compress PDF
        </button>
    </form>

    <div id="results" class="results hidden">
        <h3><i class="fas fa-check-circle"></i> Compression Results</h3>
        <div id="resultContent"></div>
    </div>
</div>

<a href="{{ url_for('index') }}" class="btn btn-secondary" style="margin: 20px auto; display: block; width: fit-content;">
    <i class="fas fa-arrow-left"></i> Back to Home
</a>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileUpload = document.getElementById('fileUpload');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const compressForm = document.getElementById('compressForm');
    const compressBtn = document.getElementById('compressBtn');
    const estimateSection = document.getElementById('estimateSection');
    const estimateContent = document.getElementById('estimateContent');
    const results = document.getElementById('results');
    const resultContent = document.getElementById('resultContent');
    
    let selectedFile = null;

    // Setup file upload
    setupFileUpload(fileUpload, fileInput, handleFile);

    function handleFile(files) {
        if (files.length > 0) {
            const file = files[0];
            if (file.type === 'application/pdf') {
                selectedFile = file;
                showFileInfo(file);
                compressBtn.disabled = false;
                getCompressionEstimate(file);
            } else {
                showAlert('Please select a valid PDF file.', 'error');
                selectedFile = null;
                compressBtn.disabled = true;
                fileInfo.classList.add('hidden');
                estimateSection.classList.add('hidden');
            }
        }
    }

    function showFileInfo(file) {
        fileInfo.innerHTML = `
            <div class="file-item">
                <div>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">(${formatFileSize(file.size)})</span>
                </div>
                <button type="button" class="file-remove" onclick="clearFile()">
                    <i class="fas fa-times"></i> Remove
                </button>
            </div>
        `;
        fileInfo.classList.remove('hidden');
    }

    function getCompressionEstimate(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/api/pdf-info', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showEstimate(data.info, file.size);
            }
        })
        .catch(error => {
            console.error('Error getting PDF info:', error);
        });
    }

    function showEstimate(info, fileSize) {
        // More realistic compression estimates based on PDF characteristics
        let estimatedReduction = 0;
        
        // Base reduction from metadata removal (usually 1-5%)
        estimatedReduction += 3;
        
        // Additional reduction based on file size (larger files compress better)
        if (fileSize > 1024 * 1024) { // > 1MB
            estimatedReduction += 15;
        } else if (fileSize > 100 * 1024) { // > 100KB
            estimatedReduction += 8;
        } else {
            estimatedReduction += 2;
        }
        
        // Add some randomness but keep it realistic
        estimatedReduction += Math.floor(Math.random() * 5);
        
        // Cap at reasonable maximum
        estimatedReduction = Math.min(estimatedReduction, 25);
        
        const estimatedNewSize = Math.floor(fileSize * (100 - estimatedReduction) / 100);
        
        estimateContent.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #667eea;">${formatFileSize(fileSize)}</div>
                    <div style="font-size: 0.9rem; color: #666;">Current Size</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">~${estimatedReduction}%</div>
                    <div style="font-size: 0.9rem; color: #666;">Est. Reduction</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #17a2b8;">${formatFileSize(estimatedNewSize)}</div>
                    <div style="font-size: 0.9rem; color: #666;">Est. New Size</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #333;">${info.pages || 'N/A'}</div>
                    <div style="font-size: 0.9rem; color: #666;">Pages</div>
                </div>
            </div>
        `;
        estimateSection.classList.remove('hidden');
    }

    window.clearFile = function() {
        selectedFile = null;
        fileInfo.classList.add('hidden');
        estimateSection.classList.add('hidden');
        compressBtn.disabled = true;
        fileInput.value = '';
    };

    // Handle form submission
    compressForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!selectedFile) {
            showAlert('Please select a PDF file to compress.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('compression_level', document.getElementById('compressionLevel').value);

        submitForm(formData, '/api/compress', compressBtn, function(data) {
            showResults(data);
        });
    });

    function showResults(data) {
        const compressionRatio = data.compression_ratio || 0;
        const originalSize = data.original_size || selectedFile.size;
        const compressedSize = data.compressed_size || originalSize;
        const savedBytes = originalSize - compressedSize;
        const isOptimized = data.note && data.note.includes('optimally compressed');
        
        // Determine colors based on compression results
        const reductionColor = compressionRatio > 0 ? '#28a745' : (compressionRatio < 0 ? '#dc3545' : '#6c757d');
        const sizeColor = compressionRatio > 0 ? '#28a745' : (compressionRatio < 0 ? '#dc3545' : '#6c757d');
        const savedColor = savedBytes > 0 ? '#28a745' : (savedBytes < 0 ? '#dc3545' : '#6c757d');
        
        resultContent.innerHTML = `
            ${isOptimized ? `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-info-circle" style="color: #856404; margin-right: 8px;"></i>
                    <strong style="color: #856404;">${data.note}</strong>
                </div>
            ` : ''}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 15px; background: #f8f9ff; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: bold; color: #667eea;">${formatFileSize(originalSize)}</div>
                    <div style="color: #666;">Original Size</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f0fff4; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: bold; color: ${sizeColor};">${formatFileSize(compressedSize)}</div>
                    <div style="color: #666;">${isOptimized ? 'Final Size' : 'Compressed Size'}</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #fff5f5; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: bold; color: ${reductionColor};">${compressionRatio.toFixed(1)}%</div>
                    <div style="color: #666;">${compressionRatio > 0 ? 'Reduction' : (compressionRatio < 0 ? 'Increase' : 'No Change')}</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                    <div style="font-size: 1.3rem; font-weight: bold; color: ${savedColor};">${formatFileSize(Math.abs(savedBytes))}</div>
                    <div style="color: #666;">${savedBytes > 0 ? 'Space Saved' : (savedBytes < 0 ? 'Size Increase' : 'No Change')}</div>
                </div>
            </div>
            <div style="text-align: center;">
                <a href="${data.download_url}" class="btn btn-success" download="${data.filename}">
                    <i class="fas fa-download"></i> Download ${isOptimized ? 'PDF' : 'Compressed PDF'}
                </a>
            </div>
        `;
        results.classList.remove('hidden');
        
        // Scroll to results
        results.scrollIntoView({ behavior: 'smooth' });
    }
});
</script>
{% endblock %}
